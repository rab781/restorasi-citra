<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restorasi Citra - Image Denoising</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Restorasi Citra</h1>
            <p>Hilangkan Noise dari Gambar Anda dengan AI</p>
        </div>

        <!-- Status Messages -->
        <div id="statusMessage"></div>

        <!-- Upload Section -->
        <section id="uploadSection">
            <div class="upload-box" id="uploadBox">
                <div class="upload-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                </div>
                <h2>Upload Gambar</h2>
                <p>Klik untuk upload atau drag & drop</p>
                <p style="font-size: 0.9rem; color: #888;">PNG, JPG, JPEG, BMP, atau TIFF (Max 16MB)</p>
                <input type="file" id="fileInput" accept="image/*">
                
                <!-- Sharpening Options -->
                <div class="sharpen-options">
                    <label for="sharpenMethod" style="font-weight: 600; color: #B95E82; display: block; margin-bottom: 8px;">
                        ðŸ”§ Penajaman Citra:
                    </label>
                    <select id="sharpenMethod" class="sharpen-select">
                        <option value="unsharp">Unsharp Masking (Rekomendasi)</option>
                        <option value="adaptive">Adaptive Sharpening</option>
                        <option value="laplacian">Laplacian (Agresif)</option>
                        <option value="none">Tanpa Penajaman</option>
                    </select>
                    
                    <label for="sharpenStrength" style="font-weight: 600; color: #B95E82; display: block; margin-top: 12px; margin-bottom: 8px;">
                        Kekuatan: <span id="strengthValue">1.2</span>
                    </label>
                    <input type="range" id="sharpenStrength" min="0.5" max="2.0" step="0.1" value="1.2" class="sharpen-slider">
                    <div style="display: flex; justify-content: space-between; font-size: 0.85rem; color: #888; margin-top: 4px;">
                        <span>Lemah (0.5)</span>
                        <span>Kuat (2.0)</span>
                    </div>
                </div>
                
                <button type="button" class="btn-upload" id="uploadBtn">Pilih Gambar</button>
            </div>
        </section>

        <!-- Loading Section -->
        <section id="loadingSection">
            <div class="spinner"></div>
            <h2>Memproses Gambar</h2>
            <p>Mohon tunggu sebentar...</p>
        </section>

        <!-- Results Section -->
        <section id="resultsSection">
            <h2 style="text-align: center; color: #B95E82; margin-bottom: 30px;">Hasil Restorasi</h2>
            
            <div class="results-grid">
                <div class="image-card">
                    <h3>Citra Asli</h3>
                    <div class="image-wrapper">
                        <img id="originalImage" alt="Citra Asli">
                    </div>
                </div>
                
                <div class="image-card">
                    <h3>Citra Restorasi</h3>
                    <div class="image-wrapper">
                        <img id="restoredImage" alt="Citra Restorasi">
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn-primary" id="downloadBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Download Hasil
                </button>
                <button class="btn-secondary" id="resetBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="1 4 1 10 7 10"/>
                        <polyline points="23 20 23 14 17 14"/>
                        <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
                    </svg>
                    Upload Lagi
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let selectedFile = null;
        let restoredImageData = null;

        // Wait for DOM to load
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const uploadBox = document.getElementById('uploadBox');
            const fileInput = document.getElementById('fileInput');
            const uploadBtn = document.getElementById('uploadBtn');
            const uploadSection = document.getElementById('uploadSection');
            const loadingSection = document.getElementById('loadingSection');
            const resultsSection = document.getElementById('resultsSection');
            const statusMessage = document.getElementById('statusMessage');
            const originalImage = document.getElementById('originalImage');
            const restoredImage = document.getElementById('restoredImage');
            const downloadBtn = document.getElementById('downloadBtn');
            const resetBtn = document.getElementById('resetBtn');
            const sharpenMethod = document.getElementById('sharpenMethod');
            const sharpenStrength = document.getElementById('sharpenStrength');
            const strengthValue = document.getElementById('strengthValue');

            // Update strength display
            sharpenStrength.addEventListener('input', (e) => {
                strengthValue.textContent = e.target.value;
            });

            // Event Listeners
            uploadBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => {
                if (e.target.files && e.target.files[0]) {
                    handleFileSelect(e.target.files[0]);
                }
            });
            downloadBtn.addEventListener('click', downloadImage);
            resetBtn.addEventListener('click', resetApp);

            // Drag and Drop
            uploadBox.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadBox.classList.add('dragover');
            });

            uploadBox.addEventListener('dragleave', () => {
                uploadBox.classList.remove('dragover');
            });

            uploadBox.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadBox.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(files[0]);
                }
            });

            // File Selection Handler
            function handleFileSelect(file) {
                if (!file) return;

                // Validate file type
                const validTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/bmp'];
                if (!validTypes.includes(file.type)) {
                    showStatus('Tipe file tidak valid. Upload PNG, JPG, atau BMP.', 'error');
                    return;
                }

                // Validate file size (max 16MB)
                if (file.size > 16 * 1024 * 1024) {
                    showStatus('Ukuran file terlalu besar. Maksimal 16MB.', 'error');
                    return;
                }

                selectedFile = file;

                // Preview original image
                const reader = new FileReader();
                reader.onload = (e) => {
                    originalImage.src = e.target.result;
                };
                reader.readAsDataURL(file);

                // Auto-start restoration
                setTimeout(() => restoreImage(), 500);
            }

            // Restore Image
            async function restoreImage() {
                if (!selectedFile) {
                    showStatus('Pilih gambar terlebih dahulu.', 'error');
                    return;
                }

                // Show loading
                uploadSection.style.display = 'none';
                loadingSection.style.display = 'flex';

                // Prepare FormData with sharpening parameters
                const formData = new FormData();
                formData.append('image', selectedFile);
                formData.append('sharpen_method', sharpenMethod.value);
                formData.append('sharpen_strength', sharpenStrength.value);

                console.log(`Sharpening: ${sharpenMethod.value} (strength: ${sharpenStrength.value})`);

                try {
                    const response = await fetch('/restore', {
                        method: 'POST',
                        body: formData
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Display restored image
                        restoredImage.src = data.restored_image;
                        restoredImageData = data.restored_image;

                        // Show results
                        loadingSection.style.display = 'none';
                        resultsSection.style.display = 'block';

                        showStatus('Restorasi berhasil!', 'success');
                    } else {
                        throw new Error(data.error || 'Gagal memproses gambar');
                    }
                } catch (error) {
                    loadingSection.style.display = 'none';
                    uploadSection.style.display = 'block';
                    showStatus('Error: ' + error.message, 'error');
                }
            }

            // Download Image
            function downloadImage() {
                if (!restoredImageData) return;

                const link = document.createElement('a');
                link.href = restoredImageData;
                link.download = 'restored_' + (selectedFile?.name || 'image.png');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showStatus('Gambar berhasil diunduh!', 'success');
            }

            // Reset App
            function resetApp() {
                selectedFile = null;
                restoredImageData = null;
                fileInput.value = '';
                
                resultsSection.style.display = 'none';
                uploadSection.style.display = 'block';
                
                originalImage.src = '';
                restoredImage.src = '';
                
                statusMessage.textContent = '';
                statusMessage.className = '';
            }

            // Show Status Message
            function showStatus(message, type) {
                statusMessage.textContent = message;
                statusMessage.className = type === 'success' ? 'status-success' : 'status-error';
                
                setTimeout(() => {
                    statusMessage.textContent = '';
                    statusMessage.className = '';
                }, 5000);
            }

            // Check Server Health
            fetch('/health')
                .then(response => response.json())
                .then(data => {
                    if (!data.model_loaded) {
                        showStatus('Warning: Model belum dimuat di server.', 'error');
                    }
                })
                .catch(error => {
                    console.error('Server health check failed:', error);
                });
        });
    </script>
</body>
</html>
